âš ï¸ **è³‡è¨Šï¼šé€™ç¯‡æ–‡ç« çš„å…§å®¹å·²åœ¨å¾ŒçºŒæ–‡ç« ä¸­è¢«æ’¤éŠ·** âš ï¸

ğŸš« **è«‹åƒè€ƒå¾ŒçºŒæ›´æ–°çš„å…§å®¹ï¼Œé¿å…ä½¿ç”¨æœ¬ç¯‡æåˆ°çš„æ–¹æ³•ã€‚** ğŸš«

ä»Šå¤©æˆ‘å€‘è¦æ”¹å–„çš„åœ°æ–¹è·Ÿæ˜¨å¤©ä¸€æ¨£ï¼Œ `entrypoint.sh`ï¼Œå†åŠ ä¸Šè£¡é¢çš„ `wait-for-psql.py`ã€‚

### æœ€åˆçš„å•é¡Œé»

åœ¨æˆ‘é‚„åœ¨åˆæ­¥èª¿æ•´ Dockerfile çš„æ™‚å€™ï¼Œæ¯æ¬¡æ¸…ç©ºè³‡æ–™åº«å¾Œç¬¬ä¸€æ¬¡å•Ÿå‹• odooï¼Œéƒ½æœƒå‡ºç¾éŒ¯èª¤è¨Šæ¯ä¸¦ä¸”å•Ÿå‹•å¤±æ•—ï¼š

    ERROR odoo odoo.modules.loading: Database odoo not initialized, you can force it with `-i base`

è§£æ±ºæ–¹æ³•å°±æ˜¯æ ¹æ“šéŒ¯èª¤è¨Šæ¯ï¼Œæ‰‹å‹•å•Ÿå‹• odoo ä¸¦åŠ ä¸Š `-i base` åƒæ•¸ï¼Œæ‰èƒ½æˆåŠŸå•Ÿå‹•ã€‚

---

### è§£æ±ºæ–¹æ¡ˆ

é›–ç„¶æ‰‹å‹•åŠ ä¸Š `-i` åƒæ•¸ã€Œä¸€æ¬¡ã€å¯ä»¥ç·©è§£å•é¡Œï¼Œä½†é€™é¡¯ç„¶ä¸æ˜¯ä¸€å€‹å¥½çš„éƒ¨ç½²å¯¦è¸ã€‚æ¥ä¸‹ä¾†æˆ‘æƒ³åˆ°æœ€ç›´è¦ºçš„è§£æ±ºæ–¹æ¡ˆæ˜¯ï¼šå…ˆæª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹ï¼Œå¦‚æœå°šæœªåˆå§‹åŒ–ï¼Œå°±è‡ªå‹•åŸ·è¡Œåˆå§‹åŒ–ï¼Œç„¶å¾Œå†é‡æ–°å•Ÿå‹•ã€‚

é¦–å…ˆï¼Œæˆ‘å€‘çœ‹çœ‹åŸå…ˆçš„ `entrypoint.sh`ï¼š

    # æ ¹æ“šå‚³å…¥çš„åƒæ•¸æ±ºå®šå¦‚ä½•å•Ÿå‹• odoo
    case "$1" in
        -- | odoo)
            shift
            if [[ "$1" == "scaffold" ]] ; then
                exec odoo "$@"  # å¦‚æœå‚³å…¥çš„åƒæ•¸æ˜¯ scaffoldï¼Œç›´æ¥åŸ·è¡Œ odoo scaffold å‘½ä»¤
            else
                wait-for-psql.py ${DB_ARGS[@]} --timeout=30  # ç­‰å¾… PostgreSQL å°±ç·’ï¼Œç„¶å¾Œå•Ÿå‹• odoo
                exec odoo "$@" "${DB_ARGS[@]}"
            fi
            ;;
        -*)
            wait-for-psql.py ${DB_ARGS[@]} --timeout=30  # åŒæ¨£ç­‰å¾…è³‡æ–™åº«æº–å‚™å°±ç·’ï¼Œç„¶å¾Œå•Ÿå‹• odoo
            exec odoo "$@" "${DB_ARGS[@]}"
            ;;
        *)
            exec "$@"  # å¦‚æœå‚³å…¥çš„ä¸æ˜¯ odoo ç›¸é—œæŒ‡ä»¤ï¼Œå‰‡åŸ·è¡Œå‚³å…¥çš„æŒ‡ä»¤
    esac

æ¥è‘—ï¼Œä¿®æ”¹å¾Œçš„ `entrypoint.sh`ï¼š

    case "$1" in
        odoo)
            shift # ç§»é™¤ $1ï¼ˆ"odoo"ï¼‰

            if [[ "$1" == "scaffold" ]]; then
                echo "$HEADER Running scaffold command..."
                echo "$HEADER Executing: $ODOO_BIN $@"
                exec $ODOO_BIN "$@"

            else
                # æ–°å¢è³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥ï¼šæ›¿æ›äº† wait-for-psql.pyï¼Œæ”¹ç”¨ check-db-status.pyï¼Œä¸¦åœ¨å•Ÿå‹•å‰æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å·²åˆå§‹åŒ–
                echo "$HEADER Checking PostgreSQL readiness and database initialization..."
                check-db-status.py "${DB_ARGS[@]}" --timeout=30
                result=$?
                if [ $result -eq 2 ]; then
                    # è‡ªå‹•åˆå§‹åŒ–è³‡æ–™åº«ï¼šå¦‚æœ check-db-status.py è¿”å›ç‹€æ…‹ç¢¼ 2ï¼ˆè¡¨ç¤ºè³‡æ–™åº«å°šæœªåˆå§‹åŒ–ï¼‰ï¼Œå‰‡åŸ·è¡Œ odoo -i base --stop-after-initï¼Œè‡ªå‹•åˆå§‹åŒ–è³‡æ–™åº«
                    echo "$HEADER Database not initialized. Running initialization..."
                    echo "$HEADER Executing: $ODOO_BIN -i base --stop-after-init ${DB_ARGS[@]}"
                    exec $ODOO_BIN -i base --stop-after-init "${DB_ARGS[@]}"
                fi
                # è³‡æ–™åº«å·²åˆå§‹åŒ–ï¼Œå•Ÿå‹• odoo
                echo "$HEADER Database is initialized. Starting odoo..."
                echo "$HEADER Executing: $ODOO_BIN $@ ${DB_ARGS[@]}"
                exec $ODOO_BIN "$@" "${DB_ARGS[@]}"
            fi
            ;;
        *)
            echo "$HEADER Executing custom command: $@"
            echo "$HEADER Executing: $@"
            exec "$@"
            ;;
    esac

æ¥ä¸‹ä¾†ï¼Œä¿®æ”¹å¾Œçš„ `check-db-status.py`ï¼š

    #!/usr/bin/env python3
    import argparse
    import psycopg2
    import sys
    import time

    def check_db_initialized(conn):
        try:
            with conn.cursor() as cur:
                # æ–°å¢è³‡æ–™åº«åˆå§‹åŒ–æª¢æŸ¥ï¼šé€éæŸ¥è©¢ ir_model è¡¨ï¼Œåˆ¤æ–·è³‡æ–™åº«æ˜¯å¦å·²åˆå§‹åŒ–
                cur.execute("SELECT 1 FROM ir_model LIMIT 1;")
            return True  # è³‡æ–™åº«å·²åˆå§‹åŒ–
        except psycopg2.Error:
            return False  # è³‡æ–™åº«å°šæœªåˆå§‹åŒ–

    if __name__ == '__main__':
        arg_parser = argparse.ArgumentParser()
        arg_parser.add_argument('--db_host', required=True)
        arg_parser.add_argument('--db_port', required=True)
        arg_parser.add_argument('--db_user', required=True)
        arg_parser.add_argument('--db_password', required=True)
        arg_parser.add_argument('--database', required=False)
        arg_parser.add_argument('--timeout', type=int, default=5)

        args = arg_parser.parse_args()

        start_time = time.time()
        while (time.time() - start_time) < args.timeout:
            try:
                # é€£ç·šåƒæ•¸èª¿æ•´ï¼šä½¿ç”¨å‚³å…¥çš„è³‡æ–™åº«è³‡è¨Šå˜—è©¦é€£ç·šï¼Œä¸¦åœ¨æŒ‡å®šçš„è¶…æ™‚æ™‚é–“å…§ä¸æ–·é‡è©¦
                conn = psycopg2.connect(user=args.db_user, host=args.db_host, port=args.db_port, password=args.db_password, dbname=args.database)
                error = ''
                db_initialized = check_db_initialized(conn)
                break
            except psycopg2.OperationalError as e:
                error = e
            else:
                conn.close()
            time.sleep(1)

        if error:
            print("Database connection failure: %s" % error, file=sys.stderr)
            sys.exit(1)

        if not db_initialized:
            # è‡ªè¨‚ç‹€æ…‹ç¢¼ï¼šå¦‚æœè³‡æ–™åº«å°šæœªåˆå§‹åŒ–ï¼Œç¨‹å¼ä»¥ç‹€æ…‹ç¢¼ 2 çµæŸï¼Œä¾› entrypoint.sh åˆ¤æ–·
            sys.exit(2)  # Custom exit code to indicate uninitialized database

        sys.exit(0)

é€™æ¨£ä¸€ä¾†ï¼Œæ–°éƒ¨ç½²çš„ç’°å¢ƒåªè¦å•Ÿå‹•å¾Œå°±æœƒè‡ªå‹•åˆå§‹åŒ–è³‡æ–™åº«ï¼Œç„¶å¾Œé‡æ–°å•Ÿå‹•ï¼Œå®Œæˆéƒ¨ç½²ã€‚

---

### è·³éæ‰‹å‹•æ­¥é©Ÿ

å¾Œä¾†ï¼Œé›–ç„¶ç›´æ¥å•Ÿå‹•å¤±æ•—çš„ç¾è±¡åœ¨æˆ‘ä¿®æ”¹ Dockerfile èˆ‡å®˜æ–¹é«˜åº¦ç›¸ä¼¼å¾Œå·²ç¶“ä¸å†å‡ºç¾ï¼Œè€Œæ˜¯æœƒå¸¶æˆ‘åˆ° `/web/database/selector` é é¢ï¼Œéœ€è¦æ‰‹å‹•å¡«å¯«è³‡æ–™åº«åç¨±ã€ç®¡ç†å“¡å¯†ç¢¼ç­‰è³‡è¨Šä¾†å»ºç«‹è³‡æ–™åº«ã€‚ä½†é€™å€‹åŠŸèƒ½å‰›å¥½ä¹Ÿå¯ä»¥è®“æˆ‘å€‘è·³éé€™å€‹æ‰‹å‹•å¡«å¯«çš„æ­¥é©Ÿï¼Œç›´æ¥ä½¿ç”¨è¨­å®šæª”ä¸­çš„è³‡æ–™è‡ªå‹•åˆå§‹åŒ–ï¼Œå°æˆ‘ä¾†èªªéå¸¸æ–¹ä¾¿ã€‚

